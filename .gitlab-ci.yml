stages:
  - pages
  - upload_pages_nirelease
  - push


pages:

  stage: pages

  image: registry.lanni/pages/doxygen:latest

  script:
    - doxygen
    - mkdir -p public
    - mv docs/html/* public/
    
  when: always

  artifacts:
    paths:
      - public

push_github:
  stage: push
 

  image: registry.lanni/nibuntu/services-20.04:latest

  script:
    - git config --global --add safe.directory '*'
    - git config remote.github_cicd.url >&- || git remote add github_cicd https://NuclearInstruments:${GITHUB_TOKEN}@github.com/NuclearInstruments/SCISDK.git
    - git push -u github_cicd HEAD:master --force

  rules:
    - if: $CI_COMMIT_TAG


docs_nirelease:
  stage: upload_pages_nirelease
  image: registry.lanni/apps/release-manager:latest
  dependencies: 
    - pages
  script:
    - mv public scisdk_docs
    - zip -r scisdk_docs.zip scisdk_docs
    - nirelease -f ni-release-docs.yaml -c -v $CI_COMMIT_TAG -m "Autogenerated by pipeline with tag $CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG
  when: on_success


